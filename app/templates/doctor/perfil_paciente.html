{% extends "base.html" %}
{% block contenido %}
<section class="pantalla-movil" style="padding-top:1rem;">
    <div class="panel-header">
        <a href="/doctor/pacientes" class="btn-volver-panel">‚Üê Pacientes</a>
        <h1 class="titulo-rojo" style="margin:0;font-size:1.1rem;">Perfil del paciente</h1>
        <div style="width:70px;"></div>
    </div>

    <div class="paciente-perfil-card">
        <div class="paciente-avatar-lg">{{ (paciente.nombre or paciente.email)[0] | upper }}</div>
        <div>
            <h2 class="paciente-perfil-nombre">{{ paciente.nombre or 'Sin nombre' }}</h2>
            <p class="paciente-perfil-email">{{ paciente.email }}</p>
            {% if perfil %}
                <p class="paciente-perfil-dato">{{ perfil.edad }} a√±os ¬∑ {{ perfil.escolaridad }} ¬∑ {{ perfil.genero }}</p>
                <p class="paciente-perfil-dato">Tutor: {{ perfil.tutor }} ({{ perfil.parentesco }})</p>
            {% endif %}
        </div>
    </div>

    <div class="acciones-crud">
        <button class="btn-crud editar" onclick="toggleEditar()">‚úèÔ∏è Editar</button>
    </div>

    <div id="form-editar" style="display:none;margin-bottom:1rem;">
        <form method="post" action="/doctor/pacientes/{{ paciente._id }}/editar" class="formulario-movil">
            <label class="etiqueta-campo">Nombre</label>
            <input type="text" name="nombre" class="campo-texto" value="{{ paciente.nombre or '' }}" required />
            <label class="etiqueta-campo">Email</label>
            <input type="email" name="email" class="campo-texto" value="{{ paciente.email }}" required />
            <button type="submit" class="boton-rojo ancho-completo">üíæ Guardar cambios</button>
            <button type="button" class="boton-rojo-borde ancho-completo" onclick="toggleEditar()">Cancelar</button>
        </form>
    </div>

    <section style="margin-top:1.2rem;">
        <h3 class="titulo-rojo" style="font-size:1rem;margin-bottom:0.8rem;">üìä Progreso en juegos</h3>
        {% if stats_por_categoria %}
            <div class="grafica-container">
                {% for cat, stats in stats_por_categoria.items() %}
                    {% set pct = ((stats.completados / stats.total) * 100) | int if stats.total > 0 else 0 %}
                    <div class="grafica-fila">
                        <div class="grafica-label">{{ cat | title }}</div>
                        <div class="grafica-barra-wrap">
                            <div class="grafica-barra" style="width:{{ pct }}%;">
                                <span class="grafica-pct">{{ pct }}%</span>
                            </div>
                        </div>
                        <div class="grafica-nums">
                            <span class="num-ok">‚úì {{ stats.completados }}</span>
                            <span class="num-fail">‚úó {{ stats.en_progreso }}</span>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="actividad-vacia">
                <span style="font-size:2rem;">üéÆ</span>
                <p>Este paciente a√∫n no ha jugado ning√∫n juego.</p>
            </div>
        {% endif %}
    </section>

    {% if resultados %}
    <section style="margin-top:1.5rem;">
        <h3 class="titulo-rojo" style="font-size:1rem;margin-bottom:0.6rem;">üïπÔ∏è √öltimas sesiones</h3>
        <div class="tabla-resultados">
            {% for r in resultados %}
                <div class="resultado-fila">
                    <div class="resultado-info">
                        <span class="resultado-juego">{{ r.juego | replace('_',' ') | title }}</span>
                        <span class="resultado-cat">{{ r.categoria }}</span>
                    </div>
                    <div class="resultado-progreso">
                        {{ r.paso_completado }}/{{ r.total_pasos }}
                        {% if r.completado %}<span class="badge-ok">‚úì</span>{% else %}<span class="badge-prog">‚Ä¶</span>{% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    {% if historial %}
    <section style="margin-top:1.5rem;">
        <h3 class="titulo-rojo" style="font-size:1rem;margin-bottom:0.6rem;">üìã Historial</h3>
        {% for h in historial %}
            <div class="historial-item">
                <div>
                    <p class="historial-actividad">{{ h.actividad }}</p>
                    <p class="historial-meta">{{ h.categoria }} ¬∑ {{ h.puntos_obtenidos }} pts ¬∑ Nivel {{ h.nivel }}</p>
                </div>
                {% if h.feedback %}<span class="badge-feedback">üí¨ Con feedback</span>
                {% else %}<a href="/doctor/evaluaciones-pendientes" class="badge-sin-feedback">‚ö†Ô∏è Sin evaluar</a>{% endif %}
            </div>
        {% endfor %}
    </section>
    {% endif %}
</section>

<style>
.panel-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; padding-bottom:0.8rem; border-bottom:1px solid #f0f0f0; }
.btn-volver-panel { background:none; border:1px solid #d32f2f; color:#d32f2f; border-radius:20px; padding:0.3rem 0.8rem; font-size:0.82rem; font-weight:600; text-decoration:none; white-space:nowrap; }
.btn-volver-panel:hover { background:#fff5f5; }
.paciente-perfil-card { display:flex; align-items:flex-start; gap:1rem; background:#fff; border-radius:14px; padding:1rem; box-shadow:0 2px 10px rgba(0,0,0,0.07); border-left:4px solid #d32f2f; margin-bottom:0.8rem; }
.paciente-avatar-lg { width:56px; height:56px; border-radius:50%; background:linear-gradient(135deg,#d32f2f,#b71c1c); color:#fff; font-size:1.5rem; font-weight:700; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
.paciente-perfil-nombre { margin:0; font-size:1.05rem; font-weight:800; color:#1a1a1a; }
.paciente-perfil-email { margin:0.1rem 0; font-size:0.8rem; color:#888; }
.paciente-perfil-dato { margin:0.1rem 0; font-size:0.82rem; color:#555; }
.acciones-crud { display:flex; gap:0.5rem; margin-bottom:0.5rem; }
.btn-crud { border:none; border-radius:8px; padding:0.4rem 0.9rem; font-size:0.82rem; font-weight:600; cursor:pointer; }
.btn-crud.editar { background:#fff3e0; color:#e65100; }
.grafica-container { display:flex; flex-direction:column; gap:0.7rem; background:#fff; border-radius:12px; padding:1rem; box-shadow:0 1px 6px rgba(0,0,0,0.06); }
.grafica-fila { display:flex; align-items:center; gap:0.6rem; }
.grafica-label { font-size:0.78rem; font-weight:600; color:#555; min-width:90px; text-transform:capitalize; }
.grafica-barra-wrap { flex:1; background:#f0f0f0; border-radius:6px; height:18px; overflow:hidden; }
.grafica-barra { height:100%; background:linear-gradient(90deg,#d32f2f,#e57373); border-radius:6px; min-width:4px; display:flex; align-items:center; justify-content:flex-end; padding-right:4px; }
.grafica-pct { font-size:0.65rem; color:#fff; font-weight:700; }
.grafica-nums { display:flex; gap:0.4rem; font-size:0.72rem; min-width:70px; }
.num-ok { color:#2e7d32; font-weight:700; }
.num-fail { color:#e65100; font-weight:700; }
.tabla-resultados { display:flex; flex-direction:column; gap:0.4rem; }
.resultado-fila { display:flex; align-items:center; justify-content:space-between; background:#fff; border-radius:8px; padding:0.6rem 0.8rem; box-shadow:0 1px 4px rgba(0,0,0,0.04); border:1px solid #f0f0f0; }
.resultado-info { display:flex; flex-direction:column; }
.resultado-juego { font-size:0.88rem; font-weight:600; color:#1a1a1a; }
.resultado-cat { font-size:0.72rem; color:#888; }
.resultado-progreso { font-size:0.82rem; font-weight:600; color:#555; display:flex; align-items:center; gap:0.3rem; }
.badge-ok { background:#e8f5e9; color:#2e7d32; padding:0.1rem 0.4rem; border-radius:8px; font-size:0.72rem; }
.badge-prog { background:#fff3e0; color:#e65100; padding:0.1rem 0.4rem; border-radius:8px; font-size:0.72rem; }
.historial-item { display:flex; align-items:center; justify-content:space-between; background:#fff; border-radius:8px; padding:0.7rem 0.9rem; margin-bottom:0.4rem; box-shadow:0 1px 4px rgba(0,0,0,0.04); border:1px solid #f0f0f0; }
.historial-actividad { margin:0; font-size:0.88rem; font-weight:600; }
.historial-meta { margin:0.1rem 0 0; font-size:0.72rem; color:#888; }
.badge-feedback { background:#e8f5e9; color:#2e7d32; font-size:0.72rem; padding:0.2rem 0.5rem; border-radius:8px; white-space:nowrap; }
.badge-sin-feedback { background:#fff3e0; color:#e65100; font-size:0.72rem; padding:0.2rem 0.5rem; border-radius:8px; white-space:nowrap; text-decoration:none; }
</style>
<script>
function toggleEditar() {
    const f = document.getElementById('form-editar');
    f.style.display = f.style.display === 'none' ? 'block' : 'none';
}
</script>
{% endblock %}
