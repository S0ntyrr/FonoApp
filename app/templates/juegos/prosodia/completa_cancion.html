{% extends "base.html" %}
{% block contenido %}
<section class="pantalla-movil">
    <div class="juegos-header">
        <a href="/juegos/prosodia" class="btn-volver-cat">‚Üê Prosodia</a>
        <h1 class="titulo-rojo centrado" style="margin:0;font-size:1.1rem;">üé∂ Completa la canci√≥n</h1>
        <div style="width:70px;"></div>
    </div>

    <div class="juego-container">
        <div class="cancion-card">
            <p class="cancion-titulo" id="cancion-titulo">üéµ Selecciona una canci√≥n</p>
        </div>

        <!-- Selector de canci√≥n -->
        <div id="selector-cancion">
            <p class="instruccion-texto">Elige una canci√≥n para practicar:</p>
            <div class="canciones-lista">
                <button class="cancion-btn" onclick="elegirCancion(0)">üåü Estrellita ¬ød√≥nde est√°s?</button>
                <button class="cancion-btn" onclick="elegirCancion(1)">üêª El oso hormiguero</button>
                <button class="cancion-btn" onclick="elegirCancion(2)">üåà Los colores del arco√≠ris</button>
            </div>
        </div>

        <!-- Letra de la canci√≥n con espacios -->
        <div id="letra-area" style="display:none;">
            <p class="instruccion-texto">üé§ Activa el micr√≥fono y canta la parte que falta (en <span style="color:#7b1fa2;font-weight:700;">morado</span>)</p>
            <div class="letra-container" id="letra-container"></div>

            <div class="mic-area">
                <button class="btn-microfono" id="btn-mic" onclick="toggleMic()">üé§</button>
                <p class="mic-estado" id="mic-estado">Toca para cantar</p>
            </div>

            <div style="display:flex; gap:0.5rem; margin-top:0.5rem;">
                <button class="boton-rojo-borde" style="flex:1;" onclick="volverSelector()">‚Üê Otra canci√≥n</button>
                <button class="boton-rojo" style="flex:1;" onclick="siguienteParte()">Siguiente parte ‚Üí</button>
            </div>
        </div>

        <!-- Resultado -->
        <div id="resultado-final" style="display:none;">
            <div class="resultado-card correcto">
                <p>üéâ ¬°Muy bien cantado!</p>
                <button class="boton-rojo ancho-completo" onclick="volverSelector()">üéµ Elegir otra canci√≥n</button>
            </div>
        </div>
    </div>
</section>

<style>
.juegos-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; padding-bottom:0.8rem; border-bottom:1px solid #f0f0f0; }
.btn-volver-cat { background:none; border:1px solid #7b1fa2; color:#7b1fa2; border-radius:20px; padding:0.35rem 0.9rem; font-size:0.85rem; font-weight:600; text-decoration:none; white-space:nowrap; }
.btn-volver-cat:hover { background:#f3e5f5; }
.juego-container { display:flex; flex-direction:column; gap:1rem; }
.cancion-card { background:linear-gradient(135deg,#f3e5f5,#e1bee7); border-radius:14px; padding:1rem; text-align:center; border-left:4px solid #7b1fa2; }
.cancion-titulo { margin:0; font-size:1rem; font-weight:700; color:#4a148c; }
.instruccion-texto { margin:0 0 0.8rem; font-size:0.85rem; color:#555; }
.canciones-lista { display:flex; flex-direction:column; gap:0.5rem; }
.cancion-btn { background:#fff; border:1.5px solid #ce93d8; border-radius:10px; padding:0.8rem 1rem; font-size:0.9rem; font-weight:600; color:#4a148c; cursor:pointer; text-align:left; transition:background 0.15s; }
.cancion-btn:hover { background:#f3e5f5; }
.letra-container { background:#fff; border-radius:12px; padding:1rem; box-shadow:0 2px 8px rgba(0,0,0,0.07); font-size:1rem; line-height:2; }
.parte-normal { color:#333; }
.parte-falta { color:#7b1fa2; font-weight:700; background:#f3e5f5; padding:0.1rem 0.3rem; border-radius:4px; }
.mic-area { display:flex; flex-direction:column; align-items:center; gap:0.5rem; margin-top:0.5rem; }
.btn-microfono { width:60px; height:60px; border-radius:50%; border:3px solid #7b1fa2; background:white; font-size:1.8rem; cursor:pointer; transition:background 0.2s; box-shadow:0 2px 8px rgba(0,0,0,0.15); }
.btn-microfono.activo { background:#f3e5f5; animation:pulso 1s infinite; }
@keyframes pulso { 0%,100%{box-shadow:0 0 0 0 rgba(123,31,162,0.4);} 50%{box-shadow:0 0 0 10px rgba(123,31,162,0);} }
.mic-estado { margin:0; font-size:0.82rem; color:#888; }
.resultado-card { border-radius:12px; padding:1rem; text-align:center; }
.resultado-card p { margin:0 0 0.5rem; font-size:1rem; font-weight:700; }
.resultado-card.correcto { background:#e8f5e9; border:2px solid #4caf50; color:#2e7d32; }
</style>

<script>
const CANCIONES = [
    {
        titulo: "üåü Estrellita ¬ød√≥nde est√°s?",
        partes: [
            { normal: "Estrellita, ¬ød√≥nde est√°s?", falta: "Me pregunto qu√© ser√°s" },
            { normal: "En el cielo o en el mar,", falta: "Una joya singular" },
            { normal: "Estrellita, ¬ød√≥nde est√°s?", falta: "Me pregunto qu√© ser√°s" },
        ]
    },
    {
        titulo: "üêª El oso hormiguero",
        partes: [
            { normal: "Soy el oso hormiguero,", falta: "como hormigas con esmero" },
            { normal: "Con mi lengua larga y fina,", falta: "busco hormigas en la colina" },
            { normal: "Soy el oso hormiguero,", falta: "el m√°s raro del sendero" },
        ]
    },
    {
        titulo: "üåà Los colores del arco√≠ris",
        partes: [
            { normal: "Rojo, naranja, amarillo,", falta: "verde, azul y moradillo" },
            { normal: "Siete colores tiene el arco,", falta: "cuando llueve y sale el sol" },
            { normal: "Rojo, naranja, amarillo,", falta: "verde, azul y moradillo" },
        ]
    },
];

let cancionActual = null;
let parteActual = 0;
let micActivo = false;
let recognition = null;

function elegirCancion(idx) {
    cancionActual = CANCIONES[idx];
    parteActual = 0;
    document.getElementById('cancion-titulo').textContent = cancionActual.titulo;
    document.getElementById('selector-cancion').style.display = 'none';
    document.getElementById('resultado-final').style.display = 'none';
    mostrarParte(0);
    document.getElementById('letra-area').style.display = 'block';
}

function mostrarParte(idx) {
    parteActual = idx;
    const p = cancionActual.partes[idx];
    const container = document.getElementById('letra-container');
    container.innerHTML = `
        <span class="parte-normal">${p.normal}</span><br>
        <span class="parte-falta">[Canta esta parte: ${p.falta}]</span>
    `;
}

function siguienteParte() {
    detenerMic();
    if (parteActual < cancionActual.partes.length - 1) {
        mostrarParte(parteActual + 1);
    } else {
        document.getElementById('letra-area').style.display = 'none';
        document.getElementById('resultado-final').style.display = 'block';
    }
}

function volverSelector() {
    detenerMic();
    document.getElementById('selector-cancion').style.display = 'block';
    document.getElementById('letra-area').style.display = 'none';
    document.getElementById('resultado-final').style.display = 'none';
}

function toggleMic() {
    if (micActivo) { detenerMic(); } else { iniciarMic(); }
}

async function iniciarMic() {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SR();
        recognition.lang = 'es-ES';
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.onresult = (e) => {
            const texto = Array.from(e.results).map(r => r[0].transcript).join(' ');
            document.getElementById('mic-estado').textContent = `üéµ "${texto}"`;
        };
        recognition.onerror = () => { detenerMic(); };
        recognition.start();
        micActivo = true;
        document.getElementById('btn-mic').classList.add('activo');
        document.getElementById('mic-estado').textContent = 'üî¥ Cantando...';
    } else {
        document.getElementById('mic-estado').textContent = 'Micr√≥fono no disponible';
    }
}

function detenerMic() {
    micActivo = false;
    if (recognition) { recognition.stop(); recognition = null; }
    document.getElementById('btn-mic').classList.remove('activo');
    document.getElementById('mic-estado').textContent = 'Toca para cantar';
}
</script>
{% endblock %}
