{% extends "base.html" %}

{% block contenido %}
<section class="pantalla-movil">
    <h1 class="titulo-rojo centrado">Resonancia</h1>

    <!-- Instrucci√≥n -->
    <div id="instruccion-escaleras" class="instruccion-res">
        <p><strong>Pronuncia el sonido de la letra m de manera prolongada como muestra el ejemplo</strong></p>
        <button class="btn-audio" onclick="reproducirEjemplo()" title="Escuchar ejemplo">üîä Escuchar ejemplo</button>
        <p class="texto-peque√±o" style="margin-top:0.5rem;">
            Recuerda iniciar desde el tono m√°s bajo hasta el m√°s alto,
            sigue el ritmo del personaje que sube por las escaleras.
        </p>
    </div>

    <!-- √Årea de escaleras -->
    <div class="escaleras-area">
        <canvas id="escaleras-canvas" width="340" height="220"></canvas>
    </div>

    <!-- Indicador de tono -->
    <div class="tono-indicador">
        <div class="tono-barra-wrap">
            <div class="tono-barra" id="tono-barra"></div>
            <div class="tono-marcador" id="tono-marcador">‚ñº</div>
        </div>
        <div class="tono-labels">
            <span>Bajo</span>
            <span>Medio</span>
            <span>Alto</span>
        </div>
    </div>

    <!-- Instrucci√≥n fase 2 -->
    <div id="instruccion-fase2" class="instruccion-res" style="display:none;">
        <p><strong>Hazlo nuevamente desde el tono m√°s alto hasta el m√°s bajo, el personaje bajar√° a tu ritmo.</strong></p>
    </div>

    <!-- Progreso -->
    <div class="res-progreso">
        <span>Nivel: <strong id="nivel-res">1</strong>/2</span>
        <span>Puntos: <strong id="puntos-res">0</strong></span>
    </div>

    <!-- Bot√≥n micr√≥fono -->
    <div style="text-align:center; margin-top:0.8rem;">
        <button id="btn-mic-res" class="btn-microfono" onclick="toggleMicRes()">üé§</button>
        <p class="texto-peque√±o centrado" id="mic-estado-res">Toca para activar el micr√≥fono</p>
    </div>

    <!-- Completado -->
    <div id="res-completado" class="res-completado oculto">
        <p>üéâ ¬°Excelente trabajo!</p>
        <button class="boton-rojo ancho-completo" onclick="reiniciarRes()">Jugar de nuevo</button>
    </div>

    <div style="margin-top:1rem; text-align:center;">
        <a href="/juegos/resonancia" class="boton-rojo-borde" style="display:inline-block; padding:0.5rem 1.2rem; text-decoration:none; border-radius:4px;">‚Üê Volver</a>
    </div>
</section>

<style>
.instruccion-res {
    background: #fff8e1;
    border: 1px solid #ffd600;
    border-radius: 10px;
    padding: 0.7rem;
    margin-bottom: 0.8rem;
    font-size: 0.88rem;
    text-align: center;
    line-height: 1.5;
}
.btn-audio {
    background: #f5f5f5;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 0.3rem 0.8rem;
    cursor: pointer;
    font-size: 0.9rem;
    margin: 0.3rem 0;
}
.btn-audio:hover { background: #e0e0e0; }
.escaleras-area {
    border-radius: 10px;
    overflow: hidden;
    border: 2px solid #e0e0e0;
    margin-bottom: 0.5rem;
    background: #f5f5f5;
}
.tono-indicador {
    margin: 0.5rem 0;
}
.tono-barra-wrap {
    height: 16px;
    background: linear-gradient(90deg, #4caf50, #ffeb3b, #f44336);
    border-radius: 8px;
    position: relative;
    margin-bottom: 0.2rem;
}
.tono-marcador {
    position: absolute;
    top: -4px;
    left: 0%;
    font-size: 1rem;
    color: #333;
    transition: left 0.1s;
    transform: translateX(-50%);
}
.tono-labels {
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
    color: #555;
}
.res-progreso {
    display: flex;
    justify-content: space-around;
    background: #f5f5f5;
    padding: 0.4rem;
    border-radius: 8px;
    font-size: 0.9rem;
}
.btn-microfono {
    width: 70px; height: 70px; border-radius: 50%;
    border: 3px solid #d32f2f; background: white;
    font-size: 2rem; cursor: pointer;
    transition: background 0.2s, transform 0.1s;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}
.btn-microfono.activo { background: #ffebee; animation: pulso 1s infinite; }
@keyframes pulso {
    0%,100% { box-shadow: 0 0 0 0 rgba(211,47,47,0.4); }
    50% { box-shadow: 0 0 0 12px rgba(211,47,47,0); }
}
.res-completado {
    background: #e8f5e9;
    border: 2px solid #4caf50;
    border-radius: 10px;
    padding: 1rem;
    text-align: center;
    margin-top: 0.5rem;
}
.oculto { display: none !important; }
</style>

<script>
const canvas = document.getElementById('escaleras-canvas');
const ctx = canvas.getContext('2d');

// Posici√≥n del personaje (0=abajo, 1=arriba)
let posPersonaje = 0; // 0 a 1
let nivelRes = 1; // 1=subir, 2=bajar
let puntosRes = 0;
let audioCtxR = null, analyserR = null, micStreamR = null, micActivoR = false, animFrameR = null;
let pitchActual = 0;
let animResFrame = null;

// Escalones
const ESCALONES = 7;

function dibujarEscaleras() {
    const W = canvas.width, H = canvas.height;
    ctx.clearRect(0, 0, W, H);

    // Fondo
    ctx.fillStyle = '#f0f0f0';
    ctx.fillRect(0, 0, W, H);

    // Escalones
    const anchoEscalon = (W - 60) / ESCALONES;
    const altoEscalon = (H - 40) / ESCALONES;

    for (let i = 0; i < ESCALONES; i++) {
        const x = 30 + i * anchoEscalon;
        const y = H - 20 - (i + 1) * altoEscalon;
        const w = anchoEscalon * (ESCALONES - i);
        const h = altoEscalon;

        // Sombra
        ctx.fillStyle = '#bdbdbd';
        ctx.fillRect(x + 3, y + 3, w, h);
        // Escal√≥n
        ctx.fillStyle = '#9e9e9e';
        ctx.fillRect(x, y, w, h);
        // Borde superior
        ctx.fillStyle = '#e0e0e0';
        ctx.fillRect(x, y, w, 4);
    }

    // Personaje (posici√≥n interpolada)
    const escalonActual = Math.round(posPersonaje * (ESCALONES - 1));
    const px = 30 + escalonActual * anchoEscalon + anchoEscalon * (ESCALONES - escalonActual) / 2;
    const py = H - 20 - (escalonActual + 1) * altoEscalon - 35;

    dibujarPersonaje(px, py);
}

function dibujarPersonaje(x, y) {
    // Cuerpo (stick figure)
    ctx.strokeStyle = '#333';
    ctx.lineWidth = 2.5;
    ctx.fillStyle = '#333';

    // Cabeza
    ctx.beginPath(); ctx.arc(x, y, 10, 0, Math.PI * 2); ctx.stroke();

    // Cuerpo
    ctx.beginPath(); ctx.moveTo(x, y + 10); ctx.lineTo(x, y + 35); ctx.stroke();

    // Brazos
    ctx.beginPath(); ctx.moveTo(x - 15, y + 20); ctx.lineTo(x + 15, y + 20); ctx.stroke();

    // Piernas
    ctx.beginPath(); ctx.moveTo(x, y + 35); ctx.lineTo(x - 12, y + 55); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(x, y + 35); ctx.lineTo(x + 12, y + 55); ctx.stroke();
}

function animarPersonaje() {
    dibujarEscaleras();
    animResFrame = requestAnimationFrame(animarPersonaje);
}

// ‚îÄ‚îÄ‚îÄ Micr√≥fono y detecci√≥n de pitch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleMicRes() {
    if (micActivoR) detenerMicRes();
    else iniciarMicRes();
}

async function iniciarMicRes() {
    try {
        micStreamR = await navigator.mediaDevices.getUserMedia({ audio: true });
        audioCtxR = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioCtxR.createMediaStreamSource(micStreamR);
        analyserR = audioCtxR.createAnalyser();
        analyserR.fftSize = 2048;
        source.connect(analyserR);
        micActivoR = true;
        document.getElementById('btn-mic-res').classList.add('activo');
        document.getElementById('mic-estado-res').textContent = 'üî¥ Activo - ¬°Canta!';
        medirPitchRes();
    } catch(e) {
        document.getElementById('mic-estado-res').textContent = '‚ùå Sin acceso al micr√≥fono';
    }
}

function detenerMicRes() {
    micActivoR = false;
    if (micStreamR) { micStreamR.getTracks().forEach(t => t.stop()); micStreamR = null; }
    if (audioCtxR) { audioCtxR.close(); audioCtxR = null; }
    if (animFrameR) { cancelAnimationFrame(animFrameR); animFrameR = null; }
    document.getElementById('btn-mic-res').classList.remove('activo');
    document.getElementById('mic-estado-res').textContent = 'Toca para activar el micr√≥fono';
}

function medirPitchRes() {
    if (!micActivoR) return;
    const dataArray = new Uint8Array(analyserR.frequencyBinCount);
    analyserR.getByteFrequencyData(dataArray);

    // Calcular volumen y frecuencia dominante
    const promedio = dataArray.reduce((a,b) => a+b, 0) / dataArray.length;
    const volPct = Math.min(100, (promedio / 128) * 100);

    if (volPct > 10) {
        // Encontrar frecuencia dominante
        let maxIdx = 0, maxVal = 0;
        for (let i = 0; i < dataArray.length; i++) {
            if (dataArray[i] > maxVal) { maxVal = dataArray[i]; maxIdx = i; }
        }
        const sampleRate = audioCtxR.sampleRate;
        const freq = maxIdx * sampleRate / analyserR.fftSize;

        // Mapear frecuencia a posici√≥n (80Hz=bajo, 800Hz=alto)
        const freqNorm = Math.max(0, Math.min(1, (freq - 80) / 720));
        pitchActual = freqNorm;

        // Actualizar marcador de tono
        document.getElementById('tono-marcador').style.left = (freqNorm * 100) + '%';

        // Mover personaje seg√∫n nivel
        if (nivelRes === 1) {
            // Subir: tono alto = posici√≥n alta
            posPersonaje = freqNorm;
        } else {
            // Bajar: tono bajo = posici√≥n alta (invertido)
            posPersonaje = 1 - freqNorm;
        }

        // Sumar puntos
        puntosRes += 1;
        document.getElementById('puntos-res').textContent = puntosRes;

        // Verificar si lleg√≥ arriba
        if (posPersonaje > 0.9 && nivelRes === 1) {
            nivelRes = 2;
            document.getElementById('nivel-res').textContent = 2;
            document.getElementById('instruccion-fase2').style.display = 'block';
        } else if (posPersonaje > 0.9 && nivelRes === 2) {
            completarRes();
        }
    }

    animFrameR = requestAnimationFrame(medirPitchRes);
}

function completarRes() {
    detenerMicRes();
    document.getElementById('res-completado').classList.remove('oculto');
}

function reiniciarRes() {
    posPersonaje = 0;
    nivelRes = 1;
    puntosRes = 0;
    document.getElementById('nivel-res').textContent = 1;
    document.getElementById('puntos-res').textContent = 0;
    document.getElementById('res-completado').classList.add('oculto');
    document.getElementById('instruccion-fase2').style.display = 'none';
    document.getElementById('tono-marcador').style.left = '0%';
}

function reproducirEjemplo() {
    try {
        const ctx2 = new (window.AudioContext || window.webkitAudioContext)();
        // Sonido "mmm" ascendente
        const freqs = [150, 200, 250, 300, 350, 400, 450, 500];
        freqs.forEach((f, i) => {
            const osc = ctx2.createOscillator();
            const gain = ctx2.createGain();
            osc.connect(gain); gain.connect(ctx2.destination);
            osc.frequency.value = f;
            osc.type = 'sine';
            gain.gain.setValueAtTime(0.2, ctx2.currentTime + i * 0.3);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx2.currentTime + i * 0.3 + 0.28);
            osc.start(ctx2.currentTime + i * 0.3);
            osc.stop(ctx2.currentTime + i * 0.3 + 0.28);
        });
    } catch(e) {}
}

window.addEventListener('DOMContentLoaded', () => {
    animarPersonaje();
});
</script>
{% endblock %}
