{% extends "base.html" %}
{% block contenido %}
<section class="pantalla-movil">
    <div class="juegos-header">
        <a href="/juegos/articulacion" class="btn-volver-cat">‚Üê Articulaci√≥n</a>
        <h1 class="titulo-rojo centrado" style="margin:0;font-size:1.1rem;">üèçÔ∏è ¬°Acelera la moto!</h1>
        <div style="width:70px;"></div>
    </div>

    <div class="juego-container">
        <div class="instruccion-card">
            <p>üé§ ¬°Habla fuerte para acelerar la moto! Cuanto m√°s fuerte hables, m√°s r√°pido va</p>
        </div>

        <!-- Pista de carreras -->
        <div class="pista-container">
            <div class="pista">
                <div class="meta-inicio">üèÅ</div>
                <div class="carretera">
                    <div class="moto" id="moto">üèçÔ∏è</div>
                    <div class="linea-meta" id="linea-meta"></div>
                </div>
                <div class="meta-fin">üèÜ</div>
            </div>
            <div class="progreso-moto">
                <div class="progreso-fill-moto" id="progreso-moto" style="width:0%"></div>
            </div>
            <p class="progreso-pct" id="progreso-pct">0%</p>
        </div>

        <!-- Indicador de volumen -->
        <div class="volumen-area">
            <div class="vol-barra-container">
                <div class="vol-barra" id="vol-barra"></div>
            </div>
            <p class="vol-label" id="vol-label">üé§ Esperando...</p>
        </div>

        <!-- Bot√≥n micr√≥fono -->
        <div style="text-align:center;">
            <button id="btn-mic" class="btn-microfono" onclick="toggleMic()">üé§</button>
            <p class="mic-estado" id="mic-estado">Toca para activar el micr√≥fono</p>
        </div>

        <!-- Resultado -->
        <div id="resultado-ganaste" class="resultado-card correcto" style="display:none;">
            <p>üèÜ ¬°Llegaste a la meta!</p>
            <p style="font-size:0.85rem;color:#555;">¬°Excelente pronunciaci√≥n!</p>
            <button class="boton-rojo ancho-completo" onclick="reiniciar()">üîÑ Correr de nuevo</button>
        </div>
    </div>
</section>

<style>
.juegos-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; padding-bottom:0.8rem; border-bottom:1px solid #f0f0f0; }
.btn-volver-cat { background:none; border:1px solid #e63946; color:#e63946; border-radius:20px; padding:0.35rem 0.9rem; font-size:0.85rem; font-weight:600; text-decoration:none; white-space:nowrap; }
.btn-volver-cat:hover { background:#fff0f8; }
.juego-container { display:flex; flex-direction:column; gap:1rem; }
.instruccion-card { background:#fff0f8; border-radius:12px; padding:0.8rem 1rem; border-left:4px solid #e63946; font-size:0.88rem; color:#880e4f; font-weight:600; }
.instruccion-card p { margin:0; }
.pista-container { background:#fff; border-radius:14px; padding:1rem; box-shadow:0 2px 10px rgba(0,0,0,0.08); }
.pista { display:flex; align-items:center; gap:0.5rem; margin-bottom:0.8rem; }
.meta-inicio, .meta-fin { font-size:1.8rem; }
.carretera { flex:1; background:linear-gradient(180deg,#555,#333); border-radius:8px; height:60px; position:relative; overflow:hidden; border:2px solid #222; }
.moto { position:absolute; left:0%; top:50%; transform:translateY(-50%); font-size:1.8rem; transition:left 0.1s linear; }
.linea-meta { position:absolute; right:5px; top:0; bottom:0; width:3px; background:repeating-linear-gradient(180deg,#fff 0,#fff 5px,#000 5px,#000 10px); }
.progreso-moto { background:#f0f0f0; border-radius:6px; height:10px; overflow:hidden; }
.progreso-fill-moto { height:100%; background:linear-gradient(90deg,#e63946,#ff6b6b); border-radius:6px; transition:width 0.1s linear; }
.progreso-pct { margin:0.3rem 0 0; font-size:0.82rem; color:#888; text-align:center; }
.volumen-area { display:flex; align-items:center; gap:0.8rem; background:#f9f9f9; border-radius:10px; padding:0.8rem; }
.vol-barra-container { flex:1; height:20px; background:#e0e0e0; border-radius:10px; overflow:hidden; }
.vol-barra { height:100%; width:0%; background:linear-gradient(90deg,#4caf50,#ffeb3b,#f44336); border-radius:10px; transition:width 0.05s; }
.vol-label { margin:0; font-size:0.82rem; color:#555; min-width:100px; text-align:center; }
.btn-microfono { width:70px; height:70px; border-radius:50%; border:3px solid #e63946; background:white; font-size:2rem; cursor:pointer; transition:background 0.2s; box-shadow:0 2px 8px rgba(0,0,0,0.15); }
.btn-microfono.activo { background:#ffebee; animation:pulso 1s infinite; }
@keyframes pulso { 0%,100%{box-shadow:0 0 0 0 rgba(230,57,70,0.4);} 50%{box-shadow:0 0 0 12px rgba(230,57,70,0);} }
.mic-estado { margin:0.3rem 0 0; font-size:0.82rem; color:#888; }
.resultado-card { border-radius:12px; padding:1rem; text-align:center; }
.resultado-card p { margin:0 0 0.5rem; font-size:1rem; font-weight:700; }
.resultado-card.correcto { background:#e8f5e9; border:2px solid #4caf50; color:#2e7d32; }
</style>

<script>
let audioCtx = null;
let analyser = null;
let micStream = null;
let micActivo = false;
let animFrame = null;
let posicion = 0; // 0 a 100
const META = 100;

function toggleMic() {
    if (micActivo) { detenerMic(); } else { iniciarMic(); }
}

async function iniciarMic() {
    try {
        micStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioCtx.createMediaStreamSource(micStream);
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 256;
        source.connect(analyser);
        micActivo = true;
        document.getElementById('btn-mic').classList.add('activo');
        document.getElementById('mic-estado').textContent = 'üî¥ ¬°Habla fuerte!';
        medir();
    } catch(e) {
        document.getElementById('mic-estado').textContent = '‚ùå No se pudo acceder al micr√≥fono';
    }
}

function detenerMic() {
    micActivo = false;
    if (micStream) { micStream.getTracks().forEach(t => t.stop()); micStream = null; }
    if (audioCtx) { audioCtx.close(); audioCtx = null; }
    if (animFrame) { cancelAnimationFrame(animFrame); animFrame = null; }
    document.getElementById('btn-mic').classList.remove('activo');
    document.getElementById('mic-estado').textContent = 'Toca para activar el micr√≥fono';
    document.getElementById('vol-barra').style.width = '0%';
    document.getElementById('vol-label').textContent = 'üé§ Esperando...';
}

function medir() {
    if (!micActivo || !analyser) return;
    const data = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(data);
    const promedio = data.reduce((a,b) => a+b, 0) / data.length;
    const volPct = Math.min(100, (promedio / 128) * 100);

    document.getElementById('vol-barra').style.width = volPct + '%';

    if (volPct > 10) {
        const incremento = volPct * 0.08;
        posicion = Math.min(META, posicion + incremento);
        actualizarMoto();
        document.getElementById('vol-label').textContent = `üèçÔ∏è ¬°Vamos! ${Math.round(volPct)}%`;
    } else {
        // Desacelerar lentamente
        posicion = Math.max(0, posicion - 0.3);
        actualizarMoto();
        document.getElementById('vol-label').textContent = 'üé§ Habla m√°s fuerte...';
    }

    if (posicion >= META) {
        detenerMic();
        document.getElementById('resultado-ganaste').style.display = 'block';
        return;
    }

    animFrame = requestAnimationFrame(medir);
}

function actualizarMoto() {
    const pct = posicion / META;
    const moto = document.getElementById('moto');
    moto.style.left = (pct * 85) + '%';
    document.getElementById('progreso-moto').style.width = posicion + '%';
    document.getElementById('progreso-pct').textContent = Math.round(posicion) + '%';
}

function reiniciar() {
    posicion = 0;
    actualizarMoto();
    document.getElementById('resultado-ganaste').style.display = 'none';
}
</script>
{% endblock %}
