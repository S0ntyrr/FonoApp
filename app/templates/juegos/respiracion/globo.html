{% extends "base.html" %}

{% block contenido %}
<section class="pantalla-movil">
    <h1 class="titulo-rojo centrado">Respiraci√≥n</h1>
    <p class="centrado" style="font-weight:bold; margin-bottom:0.3rem;">Ya conoces la respiraci√≥n<br>correcta es hora de inflar tu globo.</p>
    <p class="centrado texto-peque√±o" style="color:#888; margin-bottom:1rem;">Recuerda seguir las instrucciones anteriores.</p>

    <!-- √Årea del globo -->
    <div class="globo-area">
        <div class="globo-container">
            <svg id="globo-svg" viewBox="0 0 200 280" xmlns="http://www.w3.org/2000/svg" width="180" height="252">
                <!-- Globo (se escala con JS) -->
                <g id="globo-g" transform="translate(100,130) scale(1)">
                    <!-- Cuerpo del globo -->
                    <ellipse id="globo-cuerpo" cx="0" cy="-20" rx="60" ry="75" fill="#e53935" opacity="0.9"/>
                    <!-- Brillo -->
                    <ellipse cx="-18" cy="-55" rx="15" ry="22" fill="rgba(255,255,255,0.35)" transform="rotate(-20)"/>
                    <ellipse cx="-22" cy="-60" rx="6" ry="10" fill="rgba(255,255,255,0.5)" transform="rotate(-20)"/>
                    <!-- Nudo -->
                    <ellipse cx="0" cy="58" rx="8" ry="6" fill="#b71c1c"/>
                    <!-- Hilo -->
                    <path d="M0,64 Q10,90 -5,110 Q-15,130 0,150" stroke="#888" stroke-width="1.5" fill="none"/>
                </g>
                <!-- Texto de nivel -->
                <text id="nivel-texto" x="100" y="240" text-anchor="middle" font-size="13" fill="#555" font-family="Arial"></text>
            </svg>
        </div>

        <!-- Indicador de volumen -->
        <div class="volumen-indicador">
            <div class="vol-barra-container">
                <div class="vol-barra" id="vol-barra"></div>
            </div>
            <div class="vol-label" id="vol-label">üé§ Esperando...</div>
        </div>
    </div>

    <!-- Estado del juego -->
    <div id="estado-juego" class="estado-juego">
        <p id="instruccion-texto">Toca el micr√≥fono y sopla para inflar el globo</p>
    </div>

    <!-- Mensaje de √©xito -->
    <div id="globo-explotado" class="globo-explotado oculto">
        <p>üí• ¬°El globo explot√≥! ¬°Muy bien!</p>
        <button class="boton-rojo ancho-completo" onclick="reiniciar()">Inflar otro globo</button>
    </div>

    <!-- Bot√≥n micr√≥fono -->
    <div style="text-align:center; margin-top:1rem;">
        <button id="btn-mic" class="btn-microfono" onclick="toggleMic()">
            üé§
        </button>
        <p class="texto-peque√±o centrado" style="margin-top:0.3rem;" id="mic-estado">Toca para activar el micr√≥fono</p>
    </div>

    <!-- Instrucciones para padres -->
    <div class="instrucciones-padres">
        <h3>Para padres y ni√±os</h3>
        <p>Antes de ir a la cama, practica la respiraci√≥n con tu ni√±o.
        Ve en busca del juguete favorito de tu peque√±o y busca un objeto para ti.
        En primer lugar acu√©state en la cama con tu hijo, col√≥cale el juguete en la barriga,
        p√≠dele que tome aire por la nariz hasta conseguir mover el juguete,
        practica 5 veces en mismo ejercicio, br√≠ndales compa√±√≠a y mu√©strale como lo haces t√∫.</p>
    </div>

    <div style="margin-top:1rem; text-align:center; display:flex; gap:0.5rem; justify-content:center; flex-wrap:wrap;">
        <a href="/juegos/respiracion" class="boton-rojo-borde" style="display:inline-block; padding:0.5rem 1.2rem; text-decoration:none; border-radius:4px;">‚Üê Respiraci√≥n</a>
        <button onclick="volverInicio()" class="boton-rojo-borde" style="padding:0.5rem 1.2rem; border-radius:4px; cursor:pointer;">üè† Inicio</button>
    </div>
<script>
function volverInicio() {
    const origen = sessionStorage.getItem('juegos_origen');
    window.location.href = origen || '/paciente/perfil';
}
</script>
</section>

<style>
.globo-area {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    background: #fff5f5;
    border-radius: 12px;
    padding: 1rem;
    border: 1px solid #ffcdd2;
}
.globo-container {
    display: flex;
    justify-content: center;
    align-items: center;
}
.volumen-indicador {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
}
.vol-barra-container {
    width: 20px;
    height: 120px;
    background: #e0e0e0;
    border-radius: 10px;
    overflow: hidden;
    display: flex;
    align-items: flex-end;
}
.vol-barra {
    width: 100%;
    height: 0%;
    background: linear-gradient(0deg, #4caf50, #ffeb3b, #f44336);
    border-radius: 10px;
    transition: height 0.1s;
}
.vol-label {
    font-size: 0.75rem;
    color: #555;
    text-align: center;
    max-width: 60px;
}
.estado-juego {
    text-align: center;
    padding: 0.5rem;
    font-size: 0.9rem;
    color: #333;
}
.globo-explotado {
    background: #fff3e0;
    border: 2px solid #ff9800;
    border-radius: 10px;
    padding: 1rem;
    text-align: center;
    margin-top: 0.5rem;
}
.btn-microfono {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    border: 3px solid #d32f2f;
    background: white;
    font-size: 2rem;
    cursor: pointer;
    transition: background 0.2s, transform 0.1s;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}
.btn-microfono.activo {
    background: #ffebee;
    animation: pulso 1s infinite;
}
.btn-microfono:active { transform: scale(0.95); }
@keyframes pulso {
    0%,100% { box-shadow: 0 0 0 0 rgba(211,47,47,0.4); }
    50% { box-shadow: 0 0 0 12px rgba(211,47,47,0); }
}
.instrucciones-padres {
    background: #f5f5f5;
    border-radius: 10px;
    padding: 0.8rem;
    margin-top: 1rem;
    font-size: 0.82rem;
    color: #444;
    line-height: 1.5;
}
.instrucciones-padres h3 { margin: 0 0 0.4rem; color: #d32f2f; font-size: 0.95rem; }
.oculto { display: none !important; }
</style>

<script>
let audioCtx = null;
let analyser = null;
let micStream = null;
let micActivo = false;
let animFrame = null;
let nivelGlobo = 0; // 0 a 100
const MAX_NIVEL = 100;

function toggleMic() {
    if (micActivo) {
        detenerMic();
    } else {
        iniciarMic();
    }
}

async function iniciarMic() {
    try {
        micStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioCtx.createMediaStreamSource(micStream);
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 256;
        source.connect(analyser);

        micActivo = true;
        document.getElementById('btn-mic').classList.add('activo');
        document.getElementById('mic-estado').textContent = 'üî¥ Micr√≥fono activo - ¬°Sopla!';
        document.getElementById('instruccion-texto').textContent = '¬°Sopla para inflar el globo!';
        medirVolumen();
    } catch(e) {
        document.getElementById('mic-estado').textContent = '‚ùå No se pudo acceder al micr√≥fono';
        console.error(e);
    }
}

function detenerMic() {
    micActivo = false;
    if (micStream) { micStream.getTracks().forEach(t => t.stop()); micStream = null; }
    if (audioCtx) { audioCtx.close(); audioCtx = null; }
    if (animFrame) { cancelAnimationFrame(animFrame); animFrame = null; }
    document.getElementById('btn-mic').classList.remove('activo');
    document.getElementById('mic-estado').textContent = 'Toca para activar el micr√≥fono';
    document.getElementById('vol-barra').style.height = '0%';
    document.getElementById('vol-label').textContent = 'üé§ Esperando...';
}

function medirVolumen() {
    if (!micActivo || !analyser) return;
    const dataArray = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(dataArray);
    const promedio = dataArray.reduce((a,b) => a+b, 0) / dataArray.length;
    const volPct = Math.min(100, (promedio / 128) * 100);

    document.getElementById('vol-barra').style.height = volPct + '%';

    if (volPct > 15) {
        // Soplo detectado: inflar globo
        const incremento = volPct * 0.04;
        nivelGlobo = Math.min(MAX_NIVEL, nivelGlobo + incremento);
        actualizarGlobo();
        document.getElementById('vol-label').textContent = 'üí® Soplando!';
    } else {
        document.getElementById('vol-label').textContent = 'üé§ Sopla...';
    }

    animFrame = requestAnimationFrame(medirVolumen);
}

function actualizarGlobo() {
    const escala = 0.5 + (nivelGlobo / MAX_NIVEL) * 1.2;
    document.getElementById('globo-g').setAttribute('transform', `translate(100,130) scale(${escala})`);
    document.getElementById('nivel-texto').textContent = `Nivel: ${Math.round(nivelGlobo)}%`;

    // Cambiar color seg√∫n nivel
    const r = Math.round(229 - (nivelGlobo / 100) * 50);
    const g = Math.round(57 + (nivelGlobo / 100) * 30);
    document.getElementById('globo-cuerpo').setAttribute('fill', `rgb(${r},${g},57)`);

    if (nivelGlobo >= MAX_NIVEL) {
        explotarGlobo();
    }
}

function explotarGlobo() {
    detenerMic();
    document.getElementById('globo-svg').style.display = 'none';
    document.getElementById('globo-explotado').classList.remove('oculto');
    document.getElementById('instruccion-texto').textContent = '¬°Incre√≠ble! ¬°Inflaste el globo!';
    // Guardar resultado en la base de datos
    guardarResultadoJuego('respiracion', 'globo', 1, 1, true, 50, 1);
}

function reiniciar() {
    nivelGlobo = 0;
    document.getElementById('globo-svg').style.display = 'block';
    document.getElementById('globo-explotado').classList.add('oculto');
    document.getElementById('globo-g').setAttribute('transform', 'translate(100,130) scale(1)');
    document.getElementById('globo-cuerpo').setAttribute('fill', '#e53935');
    document.getElementById('nivel-texto').textContent = '';
    document.getElementById('instruccion-texto').textContent = 'Toca el micr√≥fono y sopla para inflar el globo';
}
</script>
{% endblock %}
