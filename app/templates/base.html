<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>{{ titulo_pagina or "FonoApp" }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#d32f2f" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/estilos.css?v=6" />
    <style>body { font-family: 'Inter', 'Segoe UI', system-ui, Arial, sans-serif; }</style>
    <script>
    /**
     * Guarda el resultado de un juego en la base de datos.
     * Llamar desde cualquier juego cuando el paciente lo complete.
     * @param {string} categoria - Categor√≠a del juego (respiracion, fonacion, etc.)
     * @param {string} juego - Nombre del juego (globo, gol, etc.)
     * @param {number} pasoCompletado - √öltimo paso completado
     * @param {number} totalPasos - Total de pasos del juego
     * @param {boolean} completado - Si el juego fue completado
     * @param {number} puntos - Puntos obtenidos (opcional)
     * @param {number} nivel - Nivel del paciente (opcional)
     */
    function guardarResultadoJuego(categoria, juego, pasoCompletado, totalPasos, completado, puntos=0, nivel=1) {
        // Obtener email del paciente: sessionStorage ‚Üí localStorage ‚Üí URL params ‚Üí fallback
        let email = sessionStorage.getItem('paciente_email')
                 || localStorage.getItem('paciente_email_actual');
        if (!email) {
            // Intentar obtener del URL actual (ej: /paciente/perfil?email=...)
            const urlParams = new URLSearchParams(window.location.search);
            email = urlParams.get('email');
        }
        if (!email) {
            // Intentar obtener del referrer URL
            try {
                const refUrl = new URL(document.referrer || window.location.href);
                email = refUrl.searchParams.get('email');
            } catch(e) {}
        }
        if (!email) email = 'paciente@tesis.com'; // Fallback de √∫ltimo recurso
        const formData = new FormData();
        formData.append('paciente_email', email);
        formData.append('categoria', categoria);
        formData.append('juego', juego);
        formData.append('paso_completado', pasoCompletado);
        formData.append('total_pasos', totalPasos);
        formData.append('completado', completado);
        formData.append('puntos', puntos);
        formData.append('nivel', nivel);
        fetch('/juegos/resultado', { method: 'POST', body: formData })
            .then(r => r.json())
            .then(data => console.log('Resultado guardado:', data))
            .catch(e => console.warn('No se pudo guardar resultado:', e));
    }

    // Funci√≥n global para volver al inicio (dashboard del usuario)
    function volverInicio() {
        const origen = sessionStorage.getItem('juegos_origen');
        window.location.href = origen || '/paciente/perfil';
    }

    // Auto-agregar bot√≥n üè† Inicio en p√°ginas de juegos si hay sessionStorage.juegos_origen
    document.addEventListener('DOMContentLoaded', function() {
        const origen = sessionStorage.getItem('juegos_origen');
        if (!origen) return;
        // Buscar botones/links de "‚Üê Volver" en p√°ginas de juegos
        const volverLinks = document.querySelectorAll('a.boton-rojo-borde, a.btn-volver-cat');
        volverLinks.forEach(link => {
            const href = link.getAttribute('href') || '';
            // Solo agregar en p√°ginas de juegos (no en admin/doctor)
            if (href.includes('/juegos/') || href === '/juegos/') {
                const parent = link.parentElement;
                if (parent && !parent.querySelector('.btn-inicio-global')) {
                    const btnInicio = document.createElement('button');
                    btnInicio.className = 'btn-inicio-global boton-rojo-borde';
                    btnInicio.style.cssText = 'padding:0.5rem 1rem;border-radius:4px;cursor:pointer;margin-left:0.5rem;';
                    btnInicio.textContent = 'üè† Inicio';
                    btnInicio.onclick = volverInicio;
                    parent.appendChild(btnInicio);
                }
            }
        });
    });
    </script>
</head>
<body class="fondo-blanco">
    <div class="contenedor-principal">
        {% block contenido %}{% endblock %}
    </div>
</body>
</html>
