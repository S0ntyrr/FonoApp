@startuml FonoApp - Diagramas de Estado por Clase

!define STATE_COLOR #E1F5FF
!define TRANSITION_COLOR #4A90E2

' ============================================
' DIAGRAMA DE ESTADO: Usuario
' ============================================
state "Usuario" as UsuarioState {
  [*] --> NoRegistrado : inicio

  NoRegistrado --> Registrado : registrarse()\n/crear usuario en DB

  Registrado --> Activo : activar()\nactivo = true

  Activo --> Inactivo : desactivar()\nactivo = false
  Inactivo --> Activo : activar()\nactivo = true

  Activo --> [*] : eliminar()
  Inactivo --> [*] : eliminar()

  note right of Registrado
    Roles disponibles:
    - admin
    - medico (doctor)
    - paciente
    - emisor
  end note

  note right of Activo
    Usuario puede:
    - Iniciar sesión
    - Acceder al sistema
    - Realizar operaciones
    según su rol
  end note
}

' ============================================
' DIAGRAMA DE ESTADO: Médico (Doctor)
' ============================================
state "Médico" as MedicoState {
  [*] --> Activo : creado por admin

  Activo --> Ocupado : cambiar_estado("ocupado")\nPOST /doctor/estado
  Activo --> EnConsulta : cambiar_estado("consulta")\nPOST /doctor/estado

  Ocupado --> Activo : cambiar_estado("activo")
  EnConsulta --> Activo : cambiar_estado("activo")
  Ocupado --> EnConsulta : cambiar_estado("consulta")
  EnConsulta --> Ocupado : cambiar_estado("ocupado")

  Activo --> [*] : eliminar por admin
  Ocupado --> [*] : eliminar por admin
  EnConsulta --> [*] : eliminar por admin

  note right of Activo
    Disponible para recibir
    nuevas asignaciones
    automáticas del admin
  end note

  note right of EnConsulta
    En sesión activa con
    un paciente
  end note
}

' ============================================
' DIAGRAMA DE ESTADO: Paciente
' ============================================
state "Paciente" as PacienteState {
  [*] --> SinPerfil : registro exitoso

  SinPerfil --> PerfilCompleto : crear perfil\nPOST /paciente/perfil

  PerfilCompleto --> PerfilCompleto : actualizar perfil\nPOST /paciente/perfil

  PerfilCompleto --> ConActividades : asignación aceptada\npor doctor

  ConActividades --> ConActividades : realizar juego\n→ guarda ResultadoJuego

  ConActividades --> [*] : eliminar paciente

  note right of PerfilCompleto
    Atributos del usuario:
    - nivel: 1
    - puntos: 0
    - estado: activo
  end note

  note right of ConActividades
    Puede tener:
    - Asignaciones activas
    - Historial de actividades
    - Resultados de juegos
    - Sesiones de uso
  end note
}

' ============================================
' DIAGRAMA DE ESTADO: Asignacion
' ============================================
state "Asignacion" as AsignacionState {
  [*] --> Pendiente : crear asignación automática\nPOST /admin/asignaciones/auto

  Pendiente --> Aceptada : doctor acepta\nPOST /doctor/asignaciones/{id}/aceptar

  Pendiente --> Cancelada : doctor cancela\nPOST /doctor/asignaciones/{id}/cancelar

  Aceptada --> Cancelada : doctor cancela\nPOST /doctor/asignaciones/{id}/cancelar

  Aceptada --> [*] : finalizada
  Cancelada --> [*] : finalizada

  note right of Pendiente
    Contiene:
    - paciente_email
    - medico_email
    - actividades_asignadas[]
    - dificultad
    - fecha_asignacion
  end note

  note right of Aceptada
    Doctor disponible para
    revisar actividades del
    paciente asignado
  end note
}

' ============================================
' DIAGRAMA DE ESTADO: ResultadoJuego
' ============================================
state "ResultadoJuego" as ResultadoState {
  [*] --> EnProgreso : paciente inicia juego

  EnProgreso --> EnProgreso : avanza pasos\npaso_completado++

  EnProgreso --> Completado : paso_completado == total_pasos\ncompletado = true

  EnProgreso --> Parcial : paciente abandona\ncompletado = false

  Completado --> [*] : guardado en DB
  Parcial --> [*] : guardado en DB

  note right of EnProgreso
    Se guarda via:
    POST /juegos/resultado
    desde el frontend JS
  end note

  note right of Completado
    Doctor puede ver en:
    - /doctor/resultados
    - /admin/resultados
  end note
}

' ============================================
' DIAGRAMA DE ESTADO: HistorialActividad
' ============================================
state "HistorialActividad" as HistorialState {
  [*] --> Registrada : actividad completada\nregistro creado

  Registrada --> Evaluada : doctor proporciona feedback\nfeedback != null

  Registrada --> [*] : sin evaluar (queda en historial)
  Evaluada --> [*] : registro finalizado

  note right of Registrada
    Atributos:
    - categoria
    - actividad
    - puntos_obtenidos
    - nivel
    - fecha
    - feedback = null
  end note

  note right of Evaluada
    Feedback del doctor:
    - Comentarios
    - Evaluación
    - Recomendaciones
    Visible en /doctor/evaluaciones-pendientes
    mientras feedback = null
  end note
}

' ============================================
' DIAGRAMA DE ESTADO: SesionApp
' ============================================
state "SesionApp" as SesionState {
  [*] --> Iniciada : paciente abre app\nfecha establecida

  Iniciada --> Activa : paciente usa la app\nminutos_conectado > 0

  Activa --> Activa : paciente continúa usando\nminutos_conectado incrementa

  Activa --> Finalizada : paciente cierra app\nminutos_conectado registrado

  Iniciada --> Finalizada : paciente cierra inmediatamente\nminutos_conectado = 0

  Finalizada --> [*] : sesión guardada\nvisible en calendario

  note right of Iniciada
    Se crea registro con:
    - paciente_email
    - fecha (datetime)
  end note

  note right of Finalizada
    Registro completo:
    - fecha
    - minutos_conectado
    Usado para calendario
    en /paciente/perfil
  end note
}

' ============================================
' DIAGRAMA DE ESTADO: Conexión Base de Datos
' ============================================
state "Database Connection" as DatabaseState {
  [*] --> Desconectada : inicio aplicación

  Desconectada --> Conectando : connect_to_mongo()\non_startup()

  Conectando --> Conectada : conexión exitosa\nmongo_client inicializado

  Conectada --> Conectada : operaciones CRUD\nget_db()

  Conectada --> Desconectando : close_mongo_connection()\non_shutdown()

  Desconectando --> Desconectada : conexión cerrada

  Conectando --> Error : error de conexión
  Error --> Desconectada : reintentar

  note right of Conectada
    Estado operativo:
    - mongo_client activo
    - Colecciones accesibles:
      usuarios, perfiles_pacientes,
      asignaciones, actividades,
      historial_actividades,
      resultados_juegos,
      sesiones_app, contenido_admin
  end note
}

@enduml
